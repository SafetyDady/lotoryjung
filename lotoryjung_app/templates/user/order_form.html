{% extends "shared/base.html" %}

{% block title %}สั่งซื้อ - {{ super() }}{% endblock %}

{% block extra_css %}
<style>
.order-summary {
    position: sticky;
    top: 20px;
}

.number-preview {
    font-family: 'Courier New', monospace;
    font-size: 1.2rem;
    font-weight: bold;
    color: #0d6efd;
}

.payout-preview {
    font-weight: bold;
    color: #198754;
}

.blocked-warning {
    background: rgba(220, 53, 69, 0.1);
    border: 1px solid rgba(220, 53, 69, 0.3);
    border-radius: 0.375rem;
    padding: 0.5rem;
    margin-top: 0.5rem;
}

.limit-warning {
    background: rgba(255, 193, 7, 0.1);
    border: 1px solid rgba(255, 193, 7, 0.3);
    border-radius: 0.375rem;
    padding: 0.5rem;
    margin-top: 0.5rem;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-1">สั่งซื้อ</h2>
                <p class="text-muted mb-0">กรอกข้อมูลการสั่งซื้อสำหรับงวดวันที่ {{ current_lottery_period() }}</p>
            </div>
            <div class="lottery-period">
                <i class="fas fa-calendar-alt me-2"></i>
                งวด: {{ current_lottery_period() }}
            </div>
        </div>
    </div>
</div>

<form id="orderForm" method="POST">
    {{ form.hidden_tag() }}
    
    <div class="row">
        <!-- Order Form -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-edit me-2"></i>
                        รายการสั่งซื้อ
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Customer Name -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            {{ form.customer_name.label(class="form-label") }}
                            {{ form.customer_name(class="form-control", placeholder="ชื่อลูกค้า (ไม่บังคับ)") }}
                        </div>
                        <div class="col-md-6">
                            {{ form.notes.label(class="form-label") }}
                            {{ form.notes(class="form-control", placeholder="หมายเหตุ (ไม่บังคับ)", rows="1") }}
                        </div>
                    </div>
                    
                    <hr>
                    
                    <!-- Order Items -->
                    <div id="orderItems">
                        <!-- Items will be added here dynamically -->
                    </div>
                    
                    <!-- Add Item Button -->
                    <div class="text-center mb-3">
                        <button type="button" class="btn btn-outline-primary" onclick="addOrderItem()">
                            <i class="fas fa-plus me-2"></i>
                            เพิ่มรายการ
                        </button>
                    </div>
                    
                    <!-- Validation Messages -->
                    <div id="validationMessages" class="alert alert-danger d-none">
                        <ul class="mb-0" id="validationList"></ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Order Summary -->
        <div class="col-lg-4">
            <div class="order-summary">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-calculator me-2"></i>
                            สรุปรายการ
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="summaryContent">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                                <p>ยังไม่มีรายการ</p>
                            </div>
                        </div>
                        
                        <hr id="summaryDivider" class="d-none">
                        
                        <div id="summaryTotal" class="d-none">
                            <div class="d-flex justify-content-between mb-2">
                                <span>จำนวนรายการ:</span>
                                <span id="totalItems">0</span>
                            </div>
                            <div class="d-flex justify-content-between mb-3">
                                <strong>ยอดรวม:</strong>
                                <strong class="text-primary" id="totalAmount">0.00 บาท</strong>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-success btn-lg" id="submitBtn" disabled>
                                    <i class="fas fa-check me-2"></i>
                                    ยืนยันการสั่งซื้อ
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="clearAll()">
                                    <i class="fas fa-trash me-2"></i>
                                    ล้างทั้งหมด
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Current Rates -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-percentage me-2"></i>
                            อัตราจ่ายปัจจุบัน
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6 mb-2">
                                <div class="border rounded p-2">
                                    <small class="text-muted">2 ตัวบน</small><br>
                                    <strong class="text-primary">90x</strong>
                                </div>
                            </div>
                            <div class="col-6 mb-2">
                                <div class="border rounded p-2">
                                    <small class="text-muted">2 ตัวล่าง</small><br>
                                    <strong class="text-primary">90x</strong>
                                </div>
                            </div>
                            <div class="col-6 mb-2">
                                <div class="border rounded p-2">
                                    <small class="text-muted">3 ตัวบน</small><br>
                                    <strong class="text-primary">900x</strong>
                                </div>
                            </div>
                            <div class="col-6 mb-2">
                                <div class="border rounded p-2">
                                    <small class="text-muted">โต๊ด</small><br>
                                    <strong class="text-primary">150x</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
let itemCounter = 0;
let orderItems = [];

// Payout rates (should be loaded from API in production)
const payoutRates = {
    '2_top': 90,
    '2_bottom': 90,
    '3_top': 900,
    'tote': 150
};

function addOrderItem() {
    itemCounter++;
    const itemHtml = `
        <div class="order-item" id="item_${itemCounter}">
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label class="form-label">ประเภท</label>
                    <select class="form-select" name="field_${itemCounter}" onchange="updateItem(${itemCounter})">
                        <option value="">เลือกประเภท</option>
                        <option value="2_top">2 ตัวบน</option>
                        <option value="2_bottom">2 ตัวล่าง</option>
                        <option value="3_top">3 ตัวบน</option>
                        <option value="tote">โต๊ด</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">เลข</label>
                    <input type="text" class="form-control number-input" name="number_${itemCounter}" 
                           placeholder="เลข" onchange="updateItem(${itemCounter})" maxlength="3">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">จำนวนเงิน</label>
                    <input type="number" class="form-control amount-input" name="amount_${itemCounter}" 
                           placeholder="0.00" min="1" step="0.01" onchange="updateItem(${itemCounter})">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">จ่ายได้สูงสุด</label>
                    <input type="text" class="form-control payout-preview" id="payout_${itemCounter}" 
                           readonly placeholder="0.00">
                </div>
            </div>
            
            <div id="warnings_${itemCounter}"></div>
            
            <button type="button" class="remove-item-btn btn btn-danger btn-sm" onclick="removeItem(${itemCounter})">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    $('#orderItems').append(itemHtml);
    updateSummary();
}

function removeItem(itemId) {
    $(`#item_${itemId}`).remove();
    orderItems = orderItems.filter(item => item.id !== itemId);
    updateSummary();
}

function updateItem(itemId) {
    const field = $(`select[name="field_${itemId}"]`).val();
    const number = $(`input[name="number_${itemId}"]`).val();
    const amount = parseFloat($(`input[name="amount_${itemId}"]`).val()) || 0;
    
    // Clear previous warnings
    $(`#warnings_${itemId}`).empty();
    
    if (field && number && amount > 0) {
        // Validate number format
        const isValid = validateNumberFormat(field, number);
        if (!isValid.valid) {
            showItemWarning(itemId, isValid.message, 'danger');
            return;
        }
        
        // Calculate payout
        const payoutRate = payoutRates[field] || 0;
        const potentialPayout = amount * payoutRate;
        $(`#payout_${itemId}`).val(potentialPayout.toFixed(2));
        
        // Check for blocked numbers (mock check)
        checkBlockedNumber(itemId, field, number);
        
        // Update order items array
        const existingIndex = orderItems.findIndex(item => item.id === itemId);
        const itemData = {
            id: itemId,
            field: field,
            number: number,
            amount: amount,
            payout: potentialPayout
        };
        
        if (existingIndex >= 0) {
            orderItems[existingIndex] = itemData;
        } else {
            orderItems.push(itemData);
        }
    } else {
        $(`#payout_${itemId}`).val('');
        orderItems = orderItems.filter(item => item.id !== itemId);
    }
    
    updateSummary();
}

function validateNumberFormat(field, number) {
    const cleanNumber = number.replace(/\D/g, '');
    
    if (!cleanNumber) {
        return { valid: false, message: 'กรุณาใส่เลข' };
    }
    
    if (field === '2_top' || field === '2_bottom') {
        if (cleanNumber.length > 2) {
            return { valid: false, message: 'เลข 2 ตัวต้องไม่เกิน 2 หลัก' };
        }
    } else if (field === '3_top') {
        if (cleanNumber.length > 3) {
            return { valid: false, message: 'เลข 3 ตัวต้องไม่เกิน 3 หลัก' };
        }
    } else if (field === 'tote') {
        if (cleanNumber.length < 2 || cleanNumber.length > 3) {
            return { valid: false, message: 'เลขโต๊ดต้องมี 2-3 หลัก' };
        }
    }
    
    return { valid: true };
}

function checkBlockedNumber(itemId, field, number) {
    // Mock blocked numbers check
    const blockedNumbers = {
        '2_top': ['00', '11'],
        '3_top': ['123']
    };
    
    const normalizedNumber = number.padStart(field === '3_top' ? 3 : 2, '0');
    
    if (blockedNumbers[field] && blockedNumbers[field].includes(normalizedNumber)) {
        showItemWarning(itemId, `เลข ${normalizedNumber} เป็นเลขอั้น จ่ายในอัตรา 0.5x`, 'warning');
    }
}

function showItemWarning(itemId, message, type) {
    const warningClass = type === 'danger' ? 'blocked-warning' : 'limit-warning';
    const iconClass = type === 'danger' ? 'fa-ban' : 'fa-exclamation-triangle';
    
    $(`#warnings_${itemId}`).html(`
        <div class="${warningClass}">
            <i class="fas ${iconClass} me-2"></i>
            ${message}
        </div>
    `);
}

function updateSummary() {
    const validItems = orderItems.filter(item => item.amount > 0);
    const totalItems = validItems.length;
    const totalAmount = validItems.reduce((sum, item) => sum + item.amount, 0);
    const totalPayout = validItems.reduce((sum, item) => sum + item.payout, 0);
    
    if (totalItems > 0) {
        // Show summary
        $('#summaryContent').html(`
            <div class="mb-3">
                ${validItems.map(item => `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <span class="number-preview">${item.number}</span>
                            <small class="text-muted d-block">${getFieldText(item.field)}</small>
                        </div>
                        <div class="text-end">
                            <div>${item.amount.toFixed(2)} บาท</div>
                            <small class="payout-preview">จ่าย: ${item.payout.toFixed(2)}</small>
                        </div>
                    </div>
                `).join('')}
            </div>
        `);
        
        $('#summaryDivider, #summaryTotal').removeClass('d-none');
        $('#totalItems').text(totalItems);
        $('#totalAmount').text(totalAmount.toFixed(2) + ' บาท');
        $('#submitBtn').prop('disabled', false);
    } else {
        // Show empty state
        $('#summaryContent').html(`
            <div class="text-center text-muted py-4">
                <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                <p>ยังไม่มีรายการ</p>
            </div>
        `);
        
        $('#summaryDivider, #summaryTotal').addClass('d-none');
        $('#submitBtn').prop('disabled', true);
    }
}

function getFieldText(field) {
    const fieldMap = {
        '2_top': '2 ตัวบน',
        '2_bottom': '2 ตัวล่าง',
        '3_top': '3 ตัวบน',
        'tote': 'โต๊ด'
    };
    return fieldMap[field] || field;
}

function clearAll() {
    if (confirm('คุณต้องการล้างรายการทั้งหมดหรือไม่?')) {
        $('#orderItems').empty();
        orderItems = [];
        itemCounter = 0;
        updateSummary();
    }
}

$(document).ready(function() {
    // Add first item automatically
    addOrderItem();
    
    // Form submission
    $('#orderForm').submit(function(e) {
        e.preventDefault();
        
        if (orderItems.length === 0) {
            alert('กรุณาเพิ่มรายการสั่งซื้อ');
            return;
        }
        
        // Show loading state
        $('#submitBtn').prop('disabled', true)
                      .html('<span class="loading-spinner me-2"></span>กำลังประมวลผล...');
        
        // Submit form (in production, use AJAX)
        setTimeout(() => {
            alert('ระบบจะส่งข้อมูลไปยัง backend ในการใช้งานจริง');
            $('#submitBtn').prop('disabled', false)
                          .html('<i class="fas fa-check me-2"></i>ยืนยันการสั่งซื้อ');
        }, 2000);
    });
});
</script>
{% endblock %}

