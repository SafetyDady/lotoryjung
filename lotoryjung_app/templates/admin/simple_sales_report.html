{% extends "admin/base.html" %}

{% block title %}‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢{% endblock %}

{% block content %}
<style>
    /* Table Styles - Inline CSS */
    .report-table {
        border-collapse: collapse !important;
        margin: 20px 0 !important;
        font-family: Arial, sans-serif !important;
        font-size: 14px !important;
        width: auto !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
    }
    
    .report-table th, .report-table td {
        border: 2px solid #333 !important;
        text-align: center !important;
        padding: 8px 12px !important;
        font-weight: bold !important;
    }
    
    /* ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á - ‡∏•‡∏≥‡∏î‡∏±‡∏ö */
    .rank-header {
        background-color: #6f42c1 !important;
        color: white !important;
        width: 60px !important;
        font-size: 14px !important;
    }
    
    .rank-cell {
        background-color: #6f42c1 !important;
        color: white !important;
        font-weight: bold !important;
        width: 60px !important;
    }
    
    /* ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á - ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏•‡∏Ç */
    .type-header {
        background-color: #1e3d59 !important;
        color: white !important;
        font-size: 16px !important;
        padding: 12px !important;
    }
    
    /* ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á - ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏¢‡πà‡∏≠‡∏¢ */
    .number-header {
        background-color: #17a2b8 !important;
        color: white !important;
        font-size: 12px !important;
        width: 60px !important;
    }
    
    .sales-header {
        background-color: #ffc107 !important;
        color: #333 !important;
        font-size: 12px !important;
        width: 80px !important;
    }
    
    .payout-header {
        background-color: #fd7e14 !important;
        color: white !important;
        font-size: 12px !important;
        width: 80px !important;
    }
    
    /* ‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• */
    .number-cell {
        background-color: #17a2b8 !important;
        color: white !important;
        font-weight: bold !important;
        font-size: 16px !important;
    }
    
    .sales-cell {
        background-color: #ffc107 !important;
        color: #333 !important;
        font-weight: bold !important;
        text-align: right !important;
    }
    
    .payout-cell {
        background-color: #fd7e14 !important;
        color: white !important;
        font-weight: bold !important;
        text-align: right !important;
    }
    
    .empty-cell {
        background-color: #f8f9fa !important;
    }
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h3><i class="fas fa-chart-bar"></i> ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏à‡πà‡∏≤‡∏¢</h3>
            <p class="text-muted">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡∏∏‡∏î (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏•‡∏Ç‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 1 ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó)</p>
            
            <!-- Loading -->
            <div id="loading" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
                </div>
                <p class="mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>
            
            <!-- Summary Cards -->
            <div id="summarySection" style="display: none;">
                <div class="row mb-4">
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card border-primary">
                            <div class="card-body text-center">
                                <h5 class="card-title text-primary">
                                    <i class="fas fa-coins"></i> ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                                </h5>
                                <h2 class="text-primary" id="grandTotal">0</h2>
                                <small class="text-muted">‡∏ö‡∏≤‡∏ó</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card border-danger">
                            <div class="card-body text-center">
                                <h5 class="card-title text-danger">
                                    <i class="fas fa-hand-holding-usd"></i> ‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡∏∏‡∏î
                                </h5>
                                <h2 class="text-danger" id="totalPayout">0</h2>
                                <small class="text-muted">‡∏ö‡∏≤‡∏ó (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 1)</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card" id="profitCard">
                            <div class="card-body text-center">
                                <h5 class="card-title" id="profitTitle">
                                    <i class="fas fa-chart-line"></i> ‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô
                                </h5>
                                <h2 id="profitLoss">0</h2>
                                <small class="text-muted">‡∏ö‡∏≤‡∏ó</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card border-info">
                            <div class="card-body text-center">
                                <h5 class="card-title text-info">
                                    <i class="fas fa-list-ol"></i> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                                </h5>
                                <h2 class="text-info" id="totalNumbers">0</h2>
                                <small class="text-muted">‡πÄ‡∏•‡∏Ç</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Top Numbers Summary -->
            <div id="topNumbersSection" style="display: none;">
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0"><i class="fas fa-trophy"></i> ‡πÄ‡∏•‡∏Ç‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 1 ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î)</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3 mb-2">
                                        <strong>2 ‡∏ï‡∏±‡∏ß‡∏ö‡∏ô:</strong>
                                        <span id="top2Top" class="text-primary">-</span>
                                        <br><small id="top2TopPayout" class="text-muted">‡∏à‡πà‡∏≤‡∏¢: 0 ‡∏ö‡∏≤‡∏ó</small>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <strong>2 ‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á:</strong>
                                        <span id="top2Bottom" class="text-primary">-</span>
                                        <br><small id="top2BottomPayout" class="text-muted">‡∏à‡πà‡∏≤‡∏¢: 0 ‡∏ö‡∏≤‡∏ó</small>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <strong>3 ‡∏ï‡∏±‡∏ß‡∏ö‡∏ô:</strong>
                                        <span id="top3Top" class="text-primary">-</span>
                                        <br><small id="top3TopPayout" class="text-muted">‡∏à‡πà‡∏≤‡∏¢: 0 ‡∏ö‡∏≤‡∏ó</small>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <strong>‡πÇ‡∏ï‡πä‡∏î:</strong>
                                        <span id="topTote" class="text-primary">-</span>
                                        <br><small id="topTotePayout" class="text-muted">‡∏à‡πà‡∏≤‡∏¢: 0 ‡∏ö‡∏≤‡∏ó</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Report Table -->
                        <!-- Report Table -->
            <div id="reportContainer" style="display: none;">
                <table class="report-table">
                    <thead>
                        <tr>
                            <th rowspan="2" class="rank-header">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                            <th colspan="3" class="type-header">2 ‡∏ï‡∏±‡∏ß‡∏ö‡∏ô</th>
                            <th colspan="3" class="type-header">2 ‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á</th>
                            <th colspan="3" class="type-header">3 ‡∏ï‡∏±‡∏ß‡∏ö‡∏ô</th>
                            <th colspan="3" class="type-header">‡πÇ‡∏ï‡πä‡∏î</th>
                        </tr>
                        <tr>
                            <!-- 2 ‡∏ï‡∏±‡∏ß‡∏ö‡∏ô -->
                            <th class="number-header">‡πÄ‡∏•‡∏Ç</th>
                            <th class="sales-header">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</th>
                            <th class="payout-header">‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢</th>
                            <!-- 2 ‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á -->
                            <th class="number-header">‡πÄ‡∏•‡∏Ç</th>
                            <th class="sales-header">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</th>
                            <th class="payout-header">‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢</th>
                            <!-- 3 ‡∏ï‡∏±‡∏ß‡∏ö‡∏ô -->
                            <th class="number-header">‡πÄ‡∏•‡∏Ç</th>
                            <th class="sales-header">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</th>
                            <th class="payout-header">‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢</th>
                            <!-- ‡πÇ‡∏ï‡πä‡∏î -->
                            <th class="number-header">‡πÄ‡∏•‡∏Ç</th>
                            <th class="sales-header">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</th>
                            <th class="payout-header">‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢</th>
                        </tr>
                    </thead>
                    <tbody id="reportTableBody">
                        <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏™‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                    </tbody>
                </table>
            </div>
            
            <!-- Error Display -->
            <div id="errorContainer" style="display: none;">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="errorMessage">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadSalesData();
});

function loadSalesData() {
    console.log('üîç Starting to load sales data...');
    
    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏•‡∏∞ top sales ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
    Promise.all([
        fetch('/admin/api/sales-summary'),
        fetch('/admin/api/top-sales')
    ])
    .then(responses => {
        console.log('üì° Received responses:', responses.map(r => ({status: r.status, ok: r.ok})));
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö HTTP status
        responses.forEach((response, index) => {
            const apiName = index === 0 ? 'sales-summary' : 'top-sales';
            console.log(`üìä API ${apiName}:`, {status: response.status, ok: response.ok});
            
            if (!response.ok) {
                if (response.status === 302) {
                    console.log('üö™ Redirecting to login...');
                    window.location.href = '/login';
                    return;
                }
                throw new Error(`HTTP Error ${response.status} for ${apiName}`);
            }
        });
        return Promise.all(responses.map(r => r.json()));
    })
    .then(([summaryData, topSalesData]) => {
        console.log('üìà Summary data:', summaryData);
        console.log('üèÜ Top sales data:', topSalesData);
        
        if (summaryData.success && topSalesData.success) {
            console.log('‚úÖ Both APIs successful, displaying data...');
            displaySummary(summaryData.data);
            displayTable(topSalesData.data);
        } else {
            const error = summaryData.error || topSalesData.error;
            console.error('‚ùå API error:', error);
            showError(error || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
        }
    })
    .catch(error => {
        console.error('üí• Exception occurred:', error);
        showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message);
    });
}

function displaySummary(summaryData) {
    const overview = summaryData.overview;
    const fieldGroups = summaryData.field_groups;
    
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡∏∏‡∏î ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡∏Ç‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 1
    let maxPayoutSum = 0;
    const fieldTypes = [
        {key: '2_top', displayId: 'top2Top', payoutId: 'top2TopPayout'},
        {key: '2_bottom', displayId: 'top2Bottom', payoutId: 'top2BottomPayout'},
        {key: '3_top', displayId: 'top3Top', payoutId: 'top3TopPayout'},
        {key: 'tote', displayId: 'topTote', payoutId: 'topTotePayout'}
    ];
    
    fieldTypes.forEach(fieldType => {
        if (fieldGroups[fieldType.key] && fieldGroups[fieldType.key].length > 0) {
            // ‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ô‡∏µ‡πâ
            const topNumber = fieldGroups[fieldType.key][0]; // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß
            maxPayoutSum += topNumber.estimated_payout;
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡∏Ç‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 1
            document.getElementById(fieldType.displayId).textContent = 
                `${topNumber.number} (${formatNumberWithComma(topNumber.total_sales)} ‡∏ö‡∏≤‡∏ó)`;
            document.getElementById(fieldType.payoutId).textContent = 
                `‡∏à‡πà‡∏≤‡∏¢: ${formatNumberWithComma(topNumber.estimated_payout)} ‡∏ö‡∏≤‡∏ó`;
        } else {
            document.getElementById(fieldType.displayId).textContent = '-';
            document.getElementById(fieldType.payoutId).textContent = '‡∏à‡πà‡∏≤‡∏¢: 0 ‡∏ö‡∏≤‡∏ó';
        }
    });
    
    document.getElementById('grandTotal').textContent = formatNumberWithComma(overview.grand_total);
    document.getElementById('totalPayout').textContent = formatNumberWithComma(maxPayoutSum);
    document.getElementById('totalNumbers').textContent = overview.total_numbers;
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô (‡πÉ‡∏ä‡πâ‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡∏∏‡∏î)
    const profitLoss = overview.grand_total - maxPayoutSum;
    const profitCard = document.getElementById('profitCard');
    const profitTitle = document.getElementById('profitTitle');
    const profitLossEl = document.getElementById('profitLoss');
    
    if (profitLoss >= 0) {
        profitCard.className = 'card border-success';
        profitTitle.className = 'card-title text-success';
        profitTitle.innerHTML = '<i class="fas fa-arrow-up"></i> ‡∏Å‡∏≥‡πÑ‡∏£';
        profitLossEl.className = 'text-success';
    } else {
        profitCard.className = 'card border-danger';
        profitTitle.className = 'card-title text-danger';
        profitTitle.innerHTML = '<i class="fas fa-arrow-down"></i> ‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô';
        profitLossEl.className = 'text-danger';
    }
    
    profitLossEl.textContent = formatNumberWithComma(Math.abs(profitLoss));
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡∏∏‡∏õ
    document.getElementById('summarySection').style.display = 'block';
    document.getElementById('topNumbersSection').style.display = 'block';
}

function displayTable(data) {
    const tbody = document.getElementById('reportTableBody');
    
    // ‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á)
    const maxRows = Math.max(
        (data['2_top'] || []).length,
        (data['2_bottom'] || []).length,
        (data['3_top'] || []).length,
        (data['tote'] || []).length,
        1 // ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÅ‡∏ñ‡∏ß
    );
    
    let tableHTML = '';
    
    for (let i = 0; i < maxRows; i++) {
        const item_2_top = (data['2_top'] || [])[i];
        const item_2_bottom = (data['2_bottom'] || [])[i];
        const item_3_top = (data['3_top'] || [])[i];
        const item_tote = (data['tote'] || [])[i];
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const hasData = item_2_top || item_2_bottom || item_3_top || item_tote;
        
        // ‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡∏¢
        if (!hasData) {
            continue;
        }
        
        tableHTML += `
            <tr>
                <td class="rank-cell">${i + 1}</td>
                <!-- 2 ‡∏ï‡∏±‡∏ß‡∏ö‡∏ô -->
                <td class="${item_2_top ? 'number-cell' : 'empty-cell'}">${item_2_top ? item_2_top.number : ''}</td>
                <td class="${item_2_top ? 'sales-cell' : 'empty-cell'}">${item_2_top ? formatNumber(item_2_top.total_sales) : ''}</td>
                <td class="${item_2_top ? 'payout-cell' : 'empty-cell'}">${item_2_top ? formatNumber(item_2_top.estimated_payout) : ''}</td>
                <!-- 2 ‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á -->
                <td class="${item_2_bottom ? 'number-cell' : 'empty-cell'}">${item_2_bottom ? item_2_bottom.number : ''}</td>
                <td class="${item_2_bottom ? 'sales-cell' : 'empty-cell'}">${item_2_bottom ? formatNumber(item_2_bottom.total_sales) : ''}</td>
                <td class="${item_2_bottom ? 'payout-cell' : 'empty-cell'}">${item_2_bottom ? formatNumber(item_2_bottom.estimated_payout) : ''}</td>
                <!-- 3 ‡∏ï‡∏±‡∏ß‡∏ö‡∏ô -->
                <td class="${item_3_top ? 'number-cell' : 'empty-cell'}">${item_3_top ? item_3_top.number : ''}</td>
                <td class="${item_3_top ? 'sales-cell' : 'empty-cell'}">${item_3_top ? formatNumber(item_3_top.total_sales) : ''}</td>
                <td class="${item_3_top ? 'payout-cell' : 'empty-cell'}">${item_3_top ? formatNumber(item_3_top.estimated_payout) : ''}</td>
                <!-- ‡πÇ‡∏ï‡πä‡∏î -->
                <td class="${item_tote ? 'number-cell' : 'empty-cell'}">${item_tote ? item_tote.number : ''}</td>
                <td class="${item_tote ? 'sales-cell' : 'empty-cell'}">${item_tote ? formatNumber(item_tote.total_sales) : ''}</td>
                <td class="${item_tote ? 'payout-cell' : 'empty-cell'}">${item_tote ? formatNumber(item_tote.estimated_payout) : ''}</td>
            </tr>
        `;
    }
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡∏¢
    if (tableHTML === '') {
        tableHTML = `
            <tr>
                <td colspan="13" class="text-center text-muted py-4">
                    <i class="fas fa-info-circle"></i> ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢
                </td>
            </tr>
        `;
    }
    
    tbody.innerHTML = tableHTML;
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    document.getElementById('loading').style.display = 'none';
    document.getElementById('reportContainer').style.display = 'block';
}

function formatNumber(num) {
    if (!num || num === 0) return '';
    return new Intl.NumberFormat('th-TH', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(num);
}

function formatNumberWithComma(num) {
    if (!num || num === 0) return '0';
    return new Intl.NumberFormat('th-TH', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(num);
}

function showError(message) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorContainer').style.display = 'block';
}
</script>
{% endblock %}
