{% extends "admin/base.html" %}

{% block title %}Risk Management Dashboard{% endblock %}

{% block header %}
<style>
    .risk-score {
        font-weight: bold;
        font-size: 1.1em;
    }
    .risk-high { color: #dc3545; }
    .risk-medium { color: #fd7e14; }
    .risk-low { color: #198754; }
    
    .alert-item {
        border-left: 4px solid;
        margin-bottom: 10px;
    }
    .alert-danger { border-left-color: #dc3545; }
    .alert-warning { border-left-color: #fd7e14; }
    
    .metric-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .metric-value {
        font-size: 2em;
        font-weight: bold;
    }
    
    .risk-table th {
        background-color: #f8f9fa;
        position: sticky;
        top: 0;
        z-index: 1;
    }
    
    .loading-spinner {
        display: none;
        text-align: center;
        padding: 20px;
    }
    
    .action-badge {
        font-size: 0.8em;
        font-weight: bold;
    }
    
    .concentration-bar {
        height: 20px;
        background: linear-gradient(90deg, #198754 0%, #fd7e14 50%, #dc3545 100%);
        border-radius: 10px;
        position: relative;
    }
    
    .concentration-indicator {
        position: absolute;
        top: -2px;
        width: 4px;
        height: 24px;
        background: #000;
        border-radius: 2px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-shield-alt text-danger"></i> Risk Management Dashboard</h2>
                <div class="d-flex gap-2">
                    <select id="batchSelect" class="form-select">
                        <option value="{{ current_batch_id }}">Batch ปัจจุบัน ({{ current_batch_id }})</option>
                    </select>
                    <button id="refreshBtn" class="btn btn-outline-primary">
                        <i class="fas fa-sync-alt"></i> รีเฟรช
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="loading-spinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">กำลังโหลด...</span>
        </div>
        <p class="mt-2">กำลังวิเคราะห์ความเสี่ยง...</p>
    </div>

    <!-- Dashboard Content -->
    <div id="dashboardContent" style="display: none;">
        <!-- Overall Metrics -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6">
                <div class="metric-card">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6>ยอดรวมทั้งหมด</h6>
                            <div class="metric-value" id="grandTotal">0</div>
                        </div>
                        <i class="fas fa-coins fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="metric-card bg-danger">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6>ความเสี่ยงสูง</h6>
                            <div class="metric-value" id="highRiskCount">0</div>
                        </div>
                        <i class="fas fa-exclamation-triangle fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="metric-card bg-warning">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6>ความเสี่ยงปานกลาง</h6>
                            <div class="metric-value" id="mediumRiskCount">0</div>
                        </div>
                        <i class="fas fa-exclamation-circle fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="metric-card bg-success">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6>Potential Payout</h6>
                            <div class="metric-value" id="totalPayout">0</div>
                        </div>
                        <i class="fas fa-money-bill-wave fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alerts Section -->
        <div class="row mb-4">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0"><i class="fas fa-bell"></i> การแจ้งเตือนความเสี่ยง</h5>
                    </div>
                    <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                        <div id="alertsContainer">
                            <p class="text-muted">กำลังโหลดการแจ้งเตือน...</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-lightbulb"></i> คำแนะนำการจัดการ</h5>
                    </div>
                    <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                        <div id="recommendationsContainer">
                            <p class="text-muted">กำลังโหลดคำแนะนำ...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Risk Summary by Level -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-pie"></i> สรุปความเสี่ยงตามระดับ</h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="riskSummaryContainer">
                            <!-- จะถูกเติมด้วย JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Risk Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-table"></i> ตารางความเสี่ยงรายเลข</h5>
                        <div class="d-flex gap-2">
                            <select id="riskLevelFilter" class="form-select form-select-sm">
                                <option value="">ทุกระดับความเสี่ยง</option>
                                <option value="HIGH">ความเสี่ยงสูง</option>
                                <option value="MEDIUM">ความเสี่ยงปานกลาง</option>
                                <option value="LOW">ความเสี่ยงต่ำ</option>
                            </select>
                            <select id="fieldFilter" class="form-select form-select-sm">
                                <option value="">ทุกประเภท</option>
                                <option value="2_top">2 ตัวบน</option>
                                <option value="2_bottom">2 ตัวล่าง</option>
                                <option value="3_top">3 ตัวบน</option>
                                <option value="tote">โต๊ด</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                            <table class="table table-striped table-hover risk-table">
                                <thead>
                                    <tr>
                                        <th>เลข</th>
                                        <th>ประเภท</th>
                                        <th>ยอดรวม</th>
                                        <th>Risk Score</th>
                                        <th>ระดับความเสี่ยง</th>
                                        <th>Concentration</th>
                                        <th>Factor Risk</th>
                                        <th>Potential Payout</th>
                                        <th>Action</th>
                                        <th>จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody id="riskTableBody">
                                    <tr>
                                        <td colspan="10" class="text-center">กำลังโหลดข้อมูล...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Risk Detail Modal -->
<div class="modal fade" id="riskDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">รายละเอียดความเสี่ยง</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="riskDetailContent">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">กำลังโหลด...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let riskData = null;
let filteredData = null;

document.addEventListener('DOMContentLoaded', function() {
    loadRiskDashboard();
    
    // Event listeners
    document.getElementById('refreshBtn').addEventListener('click', loadRiskDashboard);
    document.getElementById('batchSelect').addEventListener('change', loadRiskDashboard);
    document.getElementById('riskLevelFilter').addEventListener('change', filterRiskTable);
    document.getElementById('fieldFilter').addEventListener('change', filterRiskTable);
});

function loadRiskDashboard() {
    showLoading(true);
    
    const batchId = document.getElementById('batchSelect').value;
    
    fetch(`/admin/api/risk-dashboard?batch_id=${batchId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                riskData = data.data;
                displayDashboard(data.data);
            } else {
                showError('เกิดข้อผิดพลาด: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('เกิดข้อผิดพลาดในการโหลดข้อมูล');
        })
        .finally(() => {
            showLoading(false);
        });
}

function showLoading(show) {
    document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
    document.getElementById('dashboardContent').style.display = show ? 'none' : 'block';
}

function displayDashboard(data) {
    // Overall metrics
    document.getElementById('grandTotal').textContent = formatNumber(data.overall_metrics.grand_total);
    document.getElementById('highRiskCount').textContent = data.overall_metrics.high_risk_count;
    document.getElementById('mediumRiskCount').textContent = data.overall_metrics.medium_risk_count;
    document.getElementById('totalPayout').textContent = formatNumber(data.overall_metrics.total_potential_payout);
    
    // Alerts
    displayAlerts(data.alerts);
    
    // Recommendations
    displayRecommendations(data.recommendations);
    
    // Risk summary
    displayRiskSummary(data.risk_summary);
    
    // Risk table
    filteredData = data.top_risks;
    displayRiskTable(data.top_risks);
}

function displayAlerts(alerts) {
    const container = document.getElementById('alertsContainer');
    
    if (!alerts || alerts.length === 0) {
        container.innerHTML = '<p class="text-success"><i class="fas fa-check-circle"></i> ไม่มีการแจ้งเตือนความเสี่ยงในขณะนี้</p>';
        return;
    }
    
    container.innerHTML = alerts.map(alert => `
        <div class="alert alert-${alert.type === 'danger' ? 'danger' : 'warning'} alert-item">
            <h6 class="mb-1">${alert.title}</h6>
            <p class="mb-1">${alert.message}</p>
            <small class="text-muted">${alert.action}</small>
        </div>
    `).join('');
}

function displayRecommendations(recommendations) {
    const container = document.getElementById('recommendationsContainer');
    
    if (!recommendations || recommendations.length === 0) {
        container.innerHTML = '<p class="text-muted">ไม่มีคำแนะนำเพิ่มเติม</p>';
        return;
    }
    
    container.innerHTML = recommendations.map(rec => `
        <div class="mb-3">
            <h6 class="text-${rec.type === 'immediate' ? 'danger' : rec.type === 'monitor' ? 'warning' : 'info'}">${rec.title}</h6>
            <ul class="mb-0">
                ${rec.items.map(item => `<li>${item}</li>`).join('')}
            </ul>
        </div>
    `).join('');
}

function displayRiskSummary(summary) {
    const container = document.getElementById('riskSummaryContainer');
    
    container.innerHTML = `
        <div class="col-md-4">
            <div class="card border-danger">
                <div class="card-body text-center">
                    <h5 class="text-danger">ความเสี่ยงสูง</h5>
                    <h2 class="text-danger">${summary.HIGH.count}</h2>
                    <p>ยอดรวม: ${formatNumber(summary.HIGH.total_amount)}</p>
                    <p>Potential Payout: ${formatNumber(summary.HIGH.total_payout)}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-warning">
                <div class="card-body text-center">
                    <h5 class="text-warning">ความเสี่ยงปานกลาง</h5>
                    <h2 class="text-warning">${summary.MEDIUM.count}</h2>
                    <p>ยอดรวม: ${formatNumber(summary.MEDIUM.total_amount)}</p>
                    <p>Potential Payout: ${formatNumber(summary.MEDIUM.total_payout)}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-success">
                <div class="card-body text-center">
                    <h5 class="text-success">ความเสี่ยงต่ำ</h5>
                    <h2 class="text-success">${summary.LOW.count}</h2>
                    <p>ยอดรวม: ${formatNumber(summary.LOW.total_amount)}</p>
                    <p>Potential Payout: ${formatNumber(summary.LOW.total_payout)}</p>
                </div>
            </div>
        </div>
    `;
}

function displayRiskTable(data) {
    const tbody = document.getElementById('riskTableBody');
    
    if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center">ไม่พบข้อมูล</td></tr>';
        return;
    }
    
    tbody.innerHTML = data.map(item => `
        <tr class="risk-row" data-risk-level="${item.risk_level}">
            <td><strong>${item.number}</strong></td>
            <td><span class="badge bg-secondary">${getFieldLabel(item.field)}</span></td>
            <td>${formatNumber(item.total_amount)}</td>
            <td><span class="risk-score risk-${item.risk_level.toLowerCase()}">${item.risk_score}</span></td>
            <td><span class="badge bg-${item.risk_color}">${item.risk_level}</span></td>
            <td>
                <div class="concentration-bar">
                    <div class="concentration-indicator" style="left: ${Math.min(item.concentration_pct * 2, 100)}%"></div>
                </div>
                <small>${item.concentration_pct}%</small>
            </td>
            <td>${item.factor_risk_pct}%</td>
            <td>${formatNumber(item.potential_payout)}</td>
            <td>
                <span class="badge action-badge bg-${item.action_needed === 'STOP' ? 'danger' : item.action_needed === 'WATCH' ? 'warning' : 'success'}">
                    ${item.action_needed}
                </span>
            </td>
            <td>
                <button class="btn btn-sm btn-outline-info" onclick="showRiskDetail('${item.field}', '${item.number}')">
                    <i class="fas fa-eye"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function filterRiskTable() {
    const riskLevelFilter = document.getElementById('riskLevelFilter').value;
    const fieldFilter = document.getElementById('fieldFilter').value;
    
    if (!riskData) return;
    
    filteredData = riskData.top_risks.filter(item => {
        const riskMatch = !riskLevelFilter || item.risk_level === riskLevelFilter;
        const fieldMatch = !fieldFilter || item.field === fieldFilter;
        return riskMatch && fieldMatch;
    });
    
    displayRiskTable(filteredData);
}

function showRiskDetail(field, number) {
    const modal = new bootstrap.Modal(document.getElementById('riskDetailModal'));
    const content = document.getElementById('riskDetailContent');
    
    content.innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">กำลังโหลด...</span>
            </div>
        </div>
    `;
    
    modal.show();
    
    const batchId = document.getElementById('batchSelect').value;
    
    fetch(`/admin/api/risk-detail?field=${field}&number=${number}&batch_id=${batchId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayRiskDetailModal(data.data);
            } else {
                content.innerHTML = `<div class="alert alert-danger">เกิดข้อผิดพลาด: ${data.error}</div>`;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            content.innerHTML = `<div class="alert alert-danger">เกิดข้อผิดพลาดในการโหลดข้อมูล</div>`;
        });
}

function displayRiskDetailModal(data) {
    const content = document.getElementById('riskDetailContent');
    const risk = data.number_risk;
    
    content.innerHTML = `
        <div class="row mb-3">
            <div class="col-md-6">
                <h6>ข้อมูลเลข ${risk.number} (${getFieldLabel(risk.field)})</h6>
                <table class="table table-sm">
                    <tr><td>ยอดรวม:</td><td>${formatNumber(risk.total_amount)}</td></tr>
                    <tr><td>จำนวนคำสั่งซื้อ:</td><td>${risk.order_count}</td></tr>
                    <tr><td>จำนวนผู้ใช้:</td><td>${risk.unique_users}</td></tr>
                    <tr><td>Average Factor:</td><td>${risk.avg_factor}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>ข้อมูลความเสี่ยง</h6>
                <table class="table table-sm">
                    <tr><td>Risk Score:</td><td><span class="risk-score risk-${risk.risk_level.toLowerCase()}">${risk.risk_score}</span></td></tr>
                    <tr><td>Concentration:</td><td>${risk.concentration_pct}%</td></tr>
                    <tr><td>Factor Risk:</td><td>${risk.factor_risk_pct}%</td></tr>
                    <tr><td>User Concentration:</td><td>${risk.user_concentration_pct}%</td></tr>
                </table>
            </div>
        </div>
        
        <h6>ผู้ใช้ที่ซื้อ</h6>
        <div class="table-responsive" style="max-height: 300px;">
            <table class="table table-sm table-striped">
                <thead>
                    <tr>
                        <th>ผู้ใช้</th>
                        <th>ยอดรวม</th>
                        <th>จำนวนคำสั่งซื้อ</th>
                        <th>เปอร์เซ็นต์</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.user_details.map(user => `
                        <tr>
                            <td>${user.username}</td>
                            <td>${formatNumber(user.total_amount)}</td>
                            <td>${user.order_count}</td>
                            <td>${user.percentage}%</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        
        <h6 class="mt-3">คำแนะนำ</h6>
        <ul>
            ${data.recommendations.map(rec => `<li>${rec}</li>`).join('')}
        </ul>
    `;
}

function getFieldLabel(field) {
    const labels = {
        '2_top': '2 ตัวบน',
        '2_bottom': '2 ตัวล่าง', 
        '3_top': '3 ตัวบน',
        'tote': 'โต๊ด'
    };
    return labels[field] || field;
}

function formatNumber(num) {
    return new Intl.NumberFormat('th-TH', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
    }).format(num);
}

function showError(message) {
    // Show error message
    document.getElementById('dashboardContent').innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i> ${message}
        </div>
    `;
    document.getElementById('dashboardContent').style.display = 'block';
}
</script>
{% endblock %}
