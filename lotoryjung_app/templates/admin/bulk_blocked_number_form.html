{% extends "shared/base.html" %}

{% block title %}{{ title }} - Admin{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-ban me-2 text-danger"></i>{{ title }}
                    </h2>
                    <p class="text-muted mb-0">เพิ่มหลายเลขพร้อมกันในครั้งเดียว</p>
                </div>
                <div>
                    <a href="{{ url_for('admin.blocked_numbers') }}" class="btn btn-success me-2">
                        <i class="fas fa-list me-1"></i>ดูรายการเลขอั้น
                    </a>
                    <a href="{{ url_for('admin.add_blocked_number') }}" class="btn btn-outline-primary">
                        <i class="fas fa-plus me-1"></i>เพิ่มทีละตัว
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Form Section -->
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-table me-2"></i>กรอกเลขอั้นหลายตัว
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Warning Message -->
                    <div class="alert alert-warning mb-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>คำเตือน:</strong> การบันทึกข้อมูลจะ<strong>ล้างข้อมูลเก่าทั้งหมด</strong>ก่อน แล้วบันทึกข้อมูลใหม่เข้าไป 
                        (ใช้สำหรับการจัดการเลขอั้นแต่ละงวด)
                    </div>
                    
                    <!-- Quick Add Buttons -->
                    <div class="mb-3">
                        <label class="form-label">เริ่มต้นเร็ว:</label>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-success btn-sm" onclick="addStandardSet()">
                                <i class="fas fa-magic me-1"></i>ชุดมาตรฐาน (10+5)
                            </button>
                            <button type="button" class="btn btn-outline-info btn-sm" onclick="addSample()">
                                <i class="fas fa-flask me-1"></i>ข้อมูลตัวอย่าง
                            </button>
                        </div>
                    </div>

                    <!-- Form -->
                    <form method="POST" onsubmit="return submitForm()">
                        {{ form.hidden_tag() }}
                        
                        <!-- Hidden field for numbers data -->
                        <input type="hidden" id="numbersData" name="numbers_data" value="">
                        
                        <div class="row">
                            <!-- 2-Digit Column -->
                            <div class="col-md-6">
                                <div class="card border-primary">
                                    <div class="card-header bg-primary text-white text-center">
                                        <h6 class="mb-0">2 หลัก</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="twoDigitInputs">
                                            <!-- Dynamic inputs will be added here -->
                                        </div>
                                        <button type="button" class="btn btn-outline-primary btn-sm w-100" onclick="addTwoDigitRow()">
                                            <i class="fas fa-plus me-1"></i>เพิ่ม
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- 3-Digit Column -->
                            <div class="col-md-6">
                                <div class="card border-success">
                                    <div class="card-header bg-success text-white text-center">
                                        <h6 class="mb-0">3 หลัก</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="threeDigitInputs">
                                            <!-- Dynamic inputs will be added here -->
                                        </div>
                                        <button type="button" class="btn btn-outline-success btn-sm w-100" onclick="addThreeDigitRow()">
                                            <i class="fas fa-plus me-1"></i>เพิ่ม
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Global Settings -->
                        <div class="card mt-3">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        {{ form.reason.label(class="form-label") }}
                                        {{ form.reason(class="form-control", placeholder="เหตุผลทั่วไป (ไม่บังคับ)") }}
                                    </div>
                                    <div class="col-md-4 d-flex align-items-end">
                                        <div class="form-check">
                                            {{ form.is_active(class="form-check-input") }}
                                            {{ form.is_active.label(class="form-check-label") }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-between mt-3">
                            <div class="btn-group">
                                <button type="button" class="btn btn-outline-info" onclick="previewPermutations()">
                                    <i class="fas fa-eye me-1"></i>ดูตัวอย่าง Permutations
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="validateNumbers()">
                                    <i class="fas fa-check me-1"></i>ตรวจสอบ
                                </button>
                            </div>
                            <div class="btn-group">
                                <button type="button" class="btn btn-outline-danger" onclick="clearAll()">
                                    <i class="fas fa-trash me-1"></i>ล้างฟอร์ม
                                </button>
                                <button type="button" class="btn btn-warning" onclick="clearDatabase()">
                                    <i class="fas fa-database me-1"></i>ล้าง DB
                                </button>
                                {{ form.submit(class="btn btn-danger") }}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let twoDigitCounter = 0;
let threeDigitCounter = 0;

document.addEventListener('DOMContentLoaded', function() {
    addStandardSet();
    updateStats();
});

function addStandardSet() {
    addMultipleTwoDigit(10);
    addMultipleThreeDigit(5);
}

function addSample() {
    clearAll();
    // Add 2-digit samples
    addTwoDigitRow('12');
    addTwoDigitRow('34');
    addTwoDigitRow('56');
    
    // Add 3-digit samples
    addThreeDigitRow('123');
    addThreeDigitRow('456');
    addThreeDigitRow('789');
    
    updateStats();
}

function addTwoDigitRow(value = '') {
    twoDigitCounter++;
    const container = document.getElementById('twoDigitInputs');
    const div = document.createElement('div');
    div.className = 'input-group mb-2';
    div.id = `twoDigit_${twoDigitCounter}`;
    
    div.innerHTML = `
        <span class="input-group-text">${twoDigitCounter}</span>
        <input type="text" class="form-control" placeholder="" 
               maxlength="2" pattern="[0-9]{1,2}" value="${value}" 
               onchange="updateStats()" onkeyup="updateStats()">
        <button class="btn btn-outline-danger" type="button" onclick="removeTwoDigitRow(${twoDigitCounter})">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    container.appendChild(div);
    updateStats();
}

function addThreeDigitRow(value = '') {
    threeDigitCounter++;
    const container = document.getElementById('threeDigitInputs');
    const div = document.createElement('div');
    div.className = 'input-group mb-2';
    div.id = `threeDigit_${threeDigitCounter}`;
    
    div.innerHTML = `
        <span class="input-group-text">${threeDigitCounter}</span>
        <input type="text" class="form-control" placeholder="" 
               maxlength="3" pattern="[0-9]{1,3}" value="${value}"
               onchange="updateStats()" onkeyup="updateStats()">
        <button class="btn btn-outline-danger" type="button" onclick="removeThreeDigitRow(${threeDigitCounter})">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    container.appendChild(div);
    updateStats();
}

function addMultipleTwoDigit(count) {
    for (let i = 0; i < count; i++) {
        addTwoDigitRow();
    }
}

function addMultipleThreeDigit(count) {
    for (let i = 0; i < count; i++) {
        addThreeDigitRow();
    }
}

function removeTwoDigitRow(id) {
    const element = document.getElementById(`twoDigit_${id}`);
    if (element) {
        element.remove();
        updateStats();
    }
}

function removeThreeDigitRow(id) {
    const element = document.getElementById(`threeDigit_${id}`);
    if (element) {
        element.remove();
        updateStats();
    }
}

function clearAll() {
    document.getElementById('twoDigitInputs').innerHTML = '';
    document.getElementById('threeDigitInputs').innerHTML = '';
    twoDigitCounter = 0;
    threeDigitCounter = 0;
    updateStats();
}

function updateStats() {
    // Statistics removed - this function is kept for compatibility
    // but no longer updates any UI elements
}

function getNumbersData() {
    const twoDigitInputs = document.querySelectorAll('#twoDigitInputs input[type="text"]');
    const threeDigitInputs = document.querySelectorAll('#threeDigitInputs input[type="text"]');
    
    let numbersData = [];
    
    twoDigitInputs.forEach(input => {
        const value = input.value.trim();
        if (value) {
            numbersData.push({
                number: value,
                type: '2_digit'
            });
        }
    });
    
    threeDigitInputs.forEach(input => {
        const value = input.value.trim();
        if (value) {
            numbersData.push({
                number: value,
                type: '3_digit'
            });
        }
    });
    
    return numbersData;
}

function previewPermutations() {
    const numbers = getNumbersData();
    
    if (numbers.length === 0) {
        alert('กรุณากรอกข้อมูลก่อน 1 รายการ');
        return;
    }
    
    let preview = 'ตัวอย่าง Permutations ที่จะถูกสร้าง:\\n\\n';
    let hasData = false;
    
    numbers.forEach(item => {
        if (item.type === '2_digit') {
            hasData = true;
            const padded = item.number.padStart(2, '0');
            const reversed = padded.split('').reverse().join('');
            preview += `📋 2หลัก: "${item.number}" → "${padded}"\\n`;
            preview += `   • 2_top: ${padded}, ${reversed}\\n`;
            preview += `   • 2_bottom: ${padded}, ${reversed}\\n`;
            preview += `   รวม: 4 records\\n\\n`;
        } else if (item.type === '3_digit') {
            hasData = true;
            const padded = item.number.padStart(3, '0');
            preview += `📋 3หลัก: "${item.number}" → "${padded}"\\n`;
            preview += `   • 3_top: 6 permutations\\n`;
            preview += `   • tote: 1 tote number\\n`;
            preview += `   รวม: 7 records\\n\\n`;
        }
    });
    
    if (!hasData) {
        preview = 'ไม่มีข้อมูลให้แสดง กรุณากรอกเลขก่อน';
    }
    
    alert(preview);
}

function validateNumbers() {
    const numbers = getNumbersData();
    
    if (numbers.length === 0) {
        alert('กรุณากรอกข้อมูลก่อน 1 รายการ');
        return false;
    }
    
    let errors = [];
    
    numbers.forEach((item, index) => {
        if (item.type === '2_digit' && !/^\\d{1,2}$/.test(item.number)) {
            errors.push(`เลข "${item.number}" ต้องเป็นตัวเลข 1-2 หลัก`);
        }
        
        if (item.type === '3_digit' && !/^\\d{1,3}$/.test(item.number)) {
            errors.push(`เลข "${item.number}" ต้องเป็นตัวเลข 1-3 หลัก`);
        }
    });
    
    if (errors.length > 0) {
        alert('พบข้อผิดพลาด:\\n' + errors.slice(0, 5).join('\\n') + 
              (errors.length > 5 ? '\\n...' : ''));
        return false;
    }
    
    alert(`ตรวจสอบเรียบร้อย! พร้อมบันทึก ${numbers.length} รายการ\\n\\n⚠️ ข้อมูลเก่าทั้งหมดจะถูกลบและเปลี่ยนเป็นข้อมูลใหม่`);
    return true;
}

function submitForm() {
    const numbers = getNumbersData();
    
    if (numbers.length === 0) {
        alert('กรุณากรอกข้อมูลก่อน 1 รายการ');
        return false;
    }
    
    document.getElementById('numbersData').value = JSON.stringify(numbers);
    
    const confirmed = confirm(`🔄 ล้างและบันทึกข้อมูลใหม่\\n\\n` +
                             `📊 จำนวนเลขที่จะบันทึก: ${numbers.length} รายการ\\n` +
                             `⚠️ ข้อมูลเก่าทั้งหมดจะถูกลบออก\\n` +
                             `✅ ข้อมูลใหม่จะถูกบันทึกแทน\\n\\n` +
                             `ต้องการดำเนินการหรือไม่?`);
    
    if (confirmed) {
        // Show loading message
        const submitBtn = document.querySelector('input[type="submit"]');
        const originalText = submitBtn.value;
        submitBtn.value = '🔄 กำลังล้างและบันทึก...';
        submitBtn.disabled = true;
        
        // Add timeout to show progress
        setTimeout(() => {
            submitBtn.value = originalText;
            submitBtn.disabled = false;
        }, 3000);
    }
    
    return confirmed;
}

function clearDatabase() {
    const confirmed = confirm(
        `🗑️ ล้างเลขอั้นทั้งหมดจาก Database\\n\\n` +
        `⚠️ การดำเนินการนี้จะลบเลขอั้นทั้งหมดในระบบ\\n` +
        `✅ หลังจากลบแล้ว เลขทั้งหมดจะสามารถแทงได้\\n` +
        `🔄 การดำเนินการนี้ไม่สามารถย้อนกลับได้\\n\\n` +
        `ต้องการดำเนินการหรือไม่?`
    );
    
    if (confirmed) {
        // Create and submit form to clear database
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("admin.clear_all_blocked_numbers") }}';
        
        // Add CSRF token
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrf_token';
        csrfInput.value = '{{ csrf_token() }}';
        form.appendChild(csrfInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script>

<style>
.preview-item {
    transition: all 0.2s ease;
}

.preview-item:hover {
    background-color: #f8f9fa;
    border-color: #dee2e6 !important;
}

.table th {
    border-top: none;
}

.form-select-sm, .form-control-sm {
    font-size: 0.875rem;
}
</style>
{% endblock %}
