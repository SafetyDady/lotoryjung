{% extends "shared/base.html" %}

{% block title %}{{ title }} - Admin{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-ban me-2 text-danger"></i>{{ title }}
                    </h2>
                    <p class="text-muted mb-0">เพิ่มหลายเลขพร้อมกันในครั้งเดียว</p>
                </div>
                <div>
                    <a href="{{ url_for('admin.blocked_numbers') }}" class="btn btn-secondary me-2">
                        <i class="fas fa-arrow-left me-1"></i>กลับ
                    </a>
                    <a href="{{ url_for('admin.add_blocked_number') }}" class="btn btn-outline-primary">
                        <i class="fas fa-plus me-1"></i>เพิ่มทีละตัว
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Form Section -->
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-table me-2"></i>กรอกเลขอั้นหลายตัว
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Warning Message -->
                    <div class="alert alert-warning mb-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>คำเตือน:</strong> การบันทึกข้อมูลจะ<strong>ล้างข้อมูลเก่าทั้งหมด</strong>ก่อน แล้วบันทึกข้อมูลใหม่เข้าไป 
                        (ใช้สำหรับการจัดการเลขอั้นแต่ละงวด)
                    </div>
                    
                    <!-- Quick Add Buttons -->
                    <div class="mb-3">
                        <label class="form-label">เริ่มต้นเร็ว:</label>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-success btn-sm" onclick="addStandardSet()">
                                <i class="fas fa-magic me-1"></i>ชุดมาตรฐาน (10+5)
                            </button>
                            <button type="button" class="btn btn-outline-info btn-sm" onclick="addSample()">
                                <i class="fas fa-flask me-1"></i>ข้อมูลตัวอย่าง
                            </button>
                        </div>
                    </div>

                    <!-- Numbers Input Table -->
                    <div class="table-responsive">
                        <div class="row">
                            <!-- 2 หลัก Column -->
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-primary text-white text-center">
                                        <h6 class="mb-0">2 หลัก</h6>
                                    </div>
                                    <div class="card-body p-2">
                                        <div id="twoDigitInputs">
                                            <!-- 2-digit inputs will be added here -->
                                        </div>
                                        <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="addTwoDigitRow()">
                                            <i class="fas fa-plus"></i> เพิ่ม
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 3 หลัก Column -->
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-success text-white text-center">
                                        <h6 class="mb-0">3 หลัก</h6>
                                    </div>
                                    <div class="card-body p-2">
                                        <div id="threeDigitInputs">
                                            <!-- 3-digit inputs will be added here -->
                                        </div>
                                        <button type="button" class="btn btn-outline-success btn-sm mt-2" onclick="addThreeDigitRow()">
                                            <i class="fas fa-plus"></i> เพิ่ม
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addMultipleTwoDigit(10)">
                                +10 ช่อง (2หลัก)
                            </button>
                            <button type="button" class="btn btn-outline-success btn-sm" onclick="addMultipleThreeDigit(5)">
                                +5 ช่อง (3หลัก)
                            </button>
                            <button type="button" class="btn btn-outline-warning btn-sm" onclick="clearAll()">
                                <i class="fas fa-trash me-1"></i>ล้างทั้งหมด
                            </button>
                        </div>
                        <span class="text-muted">
                            รวม: <strong id="rowCount">0</strong> ตัว
                        </span>
                    </div>
                </div>
            </div>

            <!-- Common Settings -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-cog me-2"></i>การตั้งค่าทั่วไป
                    </h6>
                </div>
                <div class="card-body">
                    <form method="POST" id="bulkForm">
                        {{ form.hidden_tag() }}
                        
                        <div class="row">
                            <div class="col-md-8">
                                {{ form.reason.label(class="form-label") }}
                                {{ form.reason(class="form-control", rows="2", placeholder="เหตุผลทั่วไปสำหรับเลขอั้นทั้งหมด (ไม่บังคับ)") }}
                            </div>
                            <div class="col-md-4">
                                <div class="form-check form-switch mt-4">
                                    {{ form.is_active(class="form-check-input", id="isActiveSwitch") }}
                                    {{ form.is_active.label(class="form-check-label", for="isActiveSwitch") }}
                                </div>
                            </div>
                        </div>
                        
                        <input type="hidden" id="numbersData" name="numbers_data" value="">
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                            <button type="button" class="btn btn-outline-info me-md-2" onclick="previewPermutations()">
                                <i class="fas fa-eye me-1"></i>ดูตัวอย่าง Permutations
                            </button>
                            <button type="button" class="btn btn-outline-secondary me-md-2" onclick="validateNumbers()">
                                <i class="fas fa-check me-1"></i>ตรวจสอบ
                            </button>
                            {{ form.submit(class="btn btn-danger", onclick="return submitForm()") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Preview Section -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-eye me-2"></i>ตัวอย่าง
                    </h6>
                </div>
                <div class="card-body">
                    <div id="previewSection">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-info-circle fa-2x mb-2"></i>
                            <p class="mb-0">กรอกเลขเพื่อดูตัวอย่าง</p>
                            <small class="text-muted">2หลัก→4รายการ, 3หลัก→7รายการ</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>สถิติ
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border-end">
                                <h4 class="text-primary mb-0" id="stats2Digit">0</h4>
                                <small class="text-muted">2 หลัก (×4)</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <h4 class="text-success mb-0" id="stats3Digit">0</h4>
                            <small class="text-muted">3 หลัก (×7)</small>
                        </div>
                    </div>
                    <hr class="my-2">
                    <div class="text-center">
                        <h5 class="text-danger mb-0" id="statsTotal">0</h5>
                        <small class="text-muted">รวมจะบันทึก (records)</small>
                    </div>
                </div>
            </div>

            <!-- Help -->
            <div class="card mt-3">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="fas fa-lightbulb me-2 text-warning"></i>
                        เคล็ดลับ
                    </h6>
                    <ul class="list-unstyled small mb-0">
                        <li class="mb-2">
                            <i class="fas fa-magic text-warning me-1"></i>
                            <strong>2 หลัก</strong> สร้าง 4 permutations ใน field เดิม
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-magic text-warning me-1"></i>
                            <strong>3 หลัก</strong> สร้าง 6 permutations + 1 tote = 7 records
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-info-circle text-info me-1"></i>
                            เช่น: 157 → 6 ใน 3_top + 1 ใน tote
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-1"></i>
                            ระบบจะเติม 0 ข้างหน้าอัตโนมัติ
                        </li>
                        <li class="mb-0">
                            <i class="fas fa-check text-success me-1"></i>
                            กดดูตัวอย่าง Permutations ก่อนบันทึก
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let twoDigitCounter = 0;
let threeDigitCounter = 0;

document.addEventListener('DOMContentLoaded', function() {
    // Add initial standard set
    addStandardSet();
    updatePreview();
});

function addStandardSet() {
    clearAll();
    addMultipleTwoDigit(10);
    addMultipleThreeDigit(5);
}

function addSample() {
    clearAll();
    // Add sample 2-digit numbers
    addTwoDigitRow('11');
    addTwoDigitRow('22');
    addTwoDigitRow('33');
    
    // Add sample 3-digit numbers
    addThreeDigitRow('123');
    addThreeDigitRow('456');
}

function addTwoDigitRow(value = '') {
    twoDigitCounter++;
    const container = document.getElementById('twoDigitInputs');
    const div = document.createElement('div');
    div.className = 'input-group input-group-sm mb-1';
    div.id = `twoDigit_${twoDigitCounter}`;
    
    div.innerHTML = `
        <span class="input-group-text" style="width: 35px;">${twoDigitCounter}</span>
        <input type="text" class="form-control" name="two_digit_${twoDigitCounter}" 
               value="${value}" placeholder="เช่น 12, 99" maxlength="2" 
               oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 2); updatePreview()"
               onchange="updatePreview()">
        <button type="button" class="btn btn-outline-danger" onclick="removeTwoDigitRow(${twoDigitCounter})">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    container.appendChild(div);
    updateRowCount();
}

function addThreeDigitRow(value = '') {
    threeDigitCounter++;
    const container = document.getElementById('threeDigitInputs');
    const div = document.createElement('div');
    div.className = 'input-group input-group-sm mb-1';
    div.id = `threeDigit_${threeDigitCounter}`;
    
    div.innerHTML = `
        <span class="input-group-text" style="width: 35px;">${threeDigitCounter}</span>
        <input type="text" class="form-control" name="three_digit_${threeDigitCounter}" 
               value="${value}" placeholder="เช่น 123, 789" maxlength="3" 
               oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 3); updatePreview()"
               onchange="updatePreview()">
        <button type="button" class="btn btn-outline-danger" onclick="removeThreeDigitRow(${threeDigitCounter})">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    container.appendChild(div);
    updateRowCount();
}

function addMultipleTwoDigit(count) {
    for (let i = 0; i < count; i++) {
        addTwoDigitRow();
    }
}

function addMultipleThreeDigit(count) {
    for (let i = 0; i < count; i++) {
        addThreeDigitRow();
    }
}

function removeTwoDigitRow(id) {
    const element = document.getElementById(`twoDigit_${id}`);
    if (element) {
        element.remove();
        updateRowCount();
        updatePreview();
    }
}

function removeThreeDigitRow(id) {
    const element = document.getElementById(`threeDigit_${id}`);
    if (element) {
        element.remove();
        updateRowCount();
        updatePreview();
    }
}

function clearAll() {
    document.getElementById('twoDigitInputs').innerHTML = '';
    document.getElementById('threeDigitInputs').innerHTML = '';
    twoDigitCounter = 0;
    threeDigitCounter = 0;
    updateRowCount();
    updatePreview();
}

function updateRowCount() {
    const twoDigitCount = document.querySelectorAll('#twoDigitInputs .input-group').length;
    const threeDigitCount = document.querySelectorAll('#threeDigitInputs .input-group').length;
    const total = twoDigitCount + threeDigitCount;
    
    document.getElementById('rowCount').textContent = total;
}

function updatePreview() {
    const twoDigitInputs = document.querySelectorAll('#twoDigitInputs input[type="text"]');
    const threeDigitInputs = document.querySelectorAll('#threeDigitInputs input[type="text"]');
    
    let twoDigitCount = 0;
    let threeDigitCount = 0;
    
    // Count valid 2-digit numbers
    twoDigitInputs.forEach(input => {
        if (input.value.trim() && input.value.length >= 1) {
            twoDigitCount++;
        }
    });
    
    // Count valid 3-digit numbers
    threeDigitInputs.forEach(input => {
        if (input.value.trim() && input.value.length >= 1) {
            threeDigitCount++;
        }
    });
    
    // Update statistics
    document.getElementById('stats2Digit').textContent = twoDigitCount;
    document.getElementById('stats3Digit').textContent = threeDigitCount;
    
    const totalRecords = (twoDigitCount * 4) + (threeDigitCount * 7);
    document.getElementById('statsTotal').textContent = totalRecords;
}

function validateNumbers() {
    const twoDigitInputs = document.querySelectorAll('#twoDigitInputs input[type="text"]');
    const threeDigitInputs = document.querySelectorAll('#threeDigitInputs input[type="text"]');
    
    let errors = [];
    let validCount = 0;
    
    // Validate 2-digit numbers
    twoDigitInputs.forEach((input, index) => {
        const value = input.value.trim();
        if (value) {
            if (!/^\d{1,2}$/.test(value)) {
                errors.push(`2หลัก แถว ${index + 1}: รูปแบบไม่ถูกต้อง`);
                input.classList.add('is-invalid');
            } else {
                input.classList.remove('is-invalid');
                validCount++;
            }
        }
    });
    
    // Validate 3-digit numbers
    threeDigitInputs.forEach((input, index) => {
        const value = input.value.trim();
        if (value) {
            if (!/^\d{1,3}$/.test(value)) {
                errors.push(`3หลัก แถว ${index + 1}: รูปแบบไม่ถูกต้อง`);
                input.classList.add('is-invalid');
            } else {
                input.classList.remove('is-invalid');
                validCount++;
            }
        }
    });
    
    if (errors.length > 0) {
        alert('พบข้อผิดพลาด:\\n' + errors.join('\\n'));
        return false;
    }
    
    if (validCount === 0) {
        alert('กรุณากรอกเลขอย่างน้อย 1 ตัว');
        return false;
    }
    
    alert(`ตรวจสอบเรียบร้อย! พบเลขถูกต้อง ${validCount} ตัว`);
    return true;
}

function previewPermutations() {
    const twoDigitInputs = document.querySelectorAll('#twoDigitInputs input[type="text"]');
    const threeDigitInputs = document.querySelectorAll('#threeDigitInputs input[type="text"]');
    
    let preview = '🔍 ตัวอย่าง Permutations:\\n\\n';
    let hasData = false;
    
    // Preview 2-digit permutations
    twoDigitInputs.forEach((input, index) => {
        const value = input.value.trim();
        if (value && value.length >= 1) {
            hasData = true;
            const padded = value.padStart(2, '0');
            const reversed = padded.split('').reverse().join('');
            
            preview += `📋 2หลัก: "${value}" → "${padded}"\\n`;
            preview += `   • 2_top: ${padded}, ${reversed}\\n`;
            preview += `   • 2_bottom: ${padded}, ${reversed}\\n`;
            preview += `   รวม: 4 records\\n\\n`;
        }
    });
    
    // Preview 3-digit permutations
    threeDigitInputs.forEach((input, index) => {
        const value = input.value.trim();
        if (value && value.length >= 1) {
            hasData = true;
            const padded = value.padStart(3, '0');
            
            preview += `📋 3หลัก: "${value}" → "${padded}"\\n`;
            preview += `   • 3_top: 6 permutations\\n`;
            preview += `   • tote: 1 tote number\\n`;
            preview += `   รวม: 7 records\\n\\n`;
        }
    });
    
    if (!hasData) {
        preview = 'ไม่มีข้อมูลให้แสดง กรุณากรอกเลขก่อน';
    }
    
    alert(preview);
}

function submitForm() {
    if (!validateNumbers()) {
        return false;
    }
    
    const twoDigitInputs = document.querySelectorAll('#twoDigitInputs input[type="text"]');
    const threeDigitInputs = document.querySelectorAll('#threeDigitInputs input[type="text"]');
    
    let numbersData = [];
    
    // Collect 2-digit numbers
    twoDigitInputs.forEach(input => {
        const value = input.value.trim();
        if (value) {
            numbersData.push({
                number: value,
                type: '2_digit'
            });
        }
    });
    
    // Collect 3-digit numbers
    threeDigitInputs.forEach(input => {
        const value = input.value.trim();
        if (value) {
            numbersData.push({
                number: value,
                type: '3_digit'
            });
        }
    });
    
        // Set the JSON data to hidden field
    document.getElementById('numbersData').value = JSON.stringify(numbersData);
    
    return true;
}

function updateStats(count2, count3) {
    document.getElementById('stats2Digit').textContent = count2;
    document.getElementById('stats3Digit').textContent = count3;
    
    // Calculate total records (2-digit × 4, 3-digit × 7)  
    const totalRecords = (count2 * 4) + (count3 * 7);
    document.getElementById('statsTotal').textContent = totalRecords;
}

async function previewPermutations() {
    const numbers = getNumbersData();
    
    if (numbers.length === 0) {
        alert('กรุณากรอกข้อมูลก่อน 1 รายการ');
        return;
    }
    
    try {
        const response = await fetch('{{ url_for("admin.bulk_add_blocked_numbers") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(numbers)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showPermutationPreview(result);
        } else {
            alert('เกิดข้อผิดพลาด: ' + 
                  (result.error || 'ไม่สามารถดึงข้อมูลได้'));
        }
    } catch (error) {
        alert('เกิดข้อผิดพลาดในการดึงข้อมูล: ' + error.message);
        console.error(error);
    }
}

function showPermutationPreview(result) {
    const previewSection = document.getElementById('previewSection');
    let html = '';
    
    // Group by original input
    const groupedRecords = {};
    result.records.forEach(record => {
        const key = record.original_input;
        if (!groupedRecords[key]) {
            groupedRecords[key] = {};
        }
        const field = record.field;
        if (!groupedRecords[key][field]) {
            groupedRecords[key][field] = [];
        }
        groupedRecords[key][field].push(record.number_norm);
    });
    
    // Show grouped results
    Object.keys(groupedRecords).forEach(originalInput => {
        const fieldGroups = groupedRecords[originalInput];
        html += `<h6 class="mb-2"><span class="badge bg-primary">${originalInput}</span> (${originalInput.length} หลัก) รายการ:</h6>`;
        
        // Show each field group
        Object.keys(fieldGroups).forEach(field => {
            const numbers = fieldGroups[field];
            const fieldName = fieldOptions[field] || field;
            html += `<p class="mb-1"><strong>${fieldName}:</strong> `;
            numbers.forEach(number => {
                html += `<span class="badge bg-secondary me-1">${number}</span>`;
            });
            html += ` (${numbers.length} รายการ)</p>`;
        });
        html += '<hr class="my-2">';
    });
    
    previewSection.innerHTML = html;
}

function validateNumbers() {
    const numbers = getNumbersData();
    
    if (numbers.length === 0) {
        alert('กรุณากรอกข้อมูลก่อน 1 รายการ');
        return false;
    }
    
    let errors = [];
    const seen = new Set();
    
    numbers.forEach((item, index) => {
        // Check duplicates
        const key = `${item.field}:${item.number}`;
        if (seen.has(key)) {
            errors.push(`แถว ${index + 1}: เลข "${item.number}" ซ้ำกัน`);
        } else {
            seen.add(key);
        }
        
        // Check number format
        if (!/^\d{2,3}$/.test(item.number)) {
            errors.push(`แถว ${index + 1}: เลขต้องเป็นตัวเลข 2-3 หลัก`);
        }
    });
    
    if (errors.length > 0) {
        alert('พบข้อผิดพลาด:
' + errors.slice(0, 5).join('
') + 
              (errors.length > 5 ? '
...' : ''));
        return false;
    }
    
    alert(`ตรวจสอบเรียบร้อย! พร้อมบันทึก ${numbers.length} รายการ`);
    return true;
}

function submitForm() {
    const numbers = getNumbersData();
    
    if (!validateNumbers()) {
        return false;
    }
    
    // Set numbers data
    document.getElementById('numbersData').value = JSON.stringify(numbers);
    
    return confirm(`ต้องการบันทึกเลขอั้น ${numbers.length} รายการหรือไม่?`);
}
</script>
</script>

</script>

</body>
</html>

function updateStats(count2, count3) {
    document.getElementById('stats2Digit').textContent = count2;
    document.getElementById('stats3Digit').textContent = count3;
    
    // Calculate total records (2-digit × 4, 3-digit × 7)  
    const totalRecords = (count2 * 4) + (count3 * 7);
    document.getElementById('statsTotal').textContent = totalRecords;
}

function updateStats(count2, count3) {
    document.getElementById('stats2Digit').textContent = count2;
    document.getElementById('stats3Digit').textContent = count3;
    
    // Calculate total records (2-digit × 4, 3-digit × 7)
    const totalRecords = (count2 * 4) + (count3 * 7);
    document.getElementById('statsTotal').textContent = totalRecords;
}

async function previewPermutations() {
    const numbers = getNumbersData();
    
    if (numbers.length === 0) {
        alert('กรุณากรอกข้อมูลเลขอั้นอย่างน้อย 1 รายการ');
        return;
    }
    
    try {
        const response = await fetch('/admin/blocked_numbers/preview', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ numbers: numbers })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showPermutationPreview(result);
        } else {
            alert('เกิดข้อผิดพลาด: ' + (result.error || 'ไม่สามารถสร้างตัวอย่างได้'));
        }
        
    } catch (error) {
        alert('เกิดข้อผิดพลาดในการดึงข้อมูลตัวอย่าง');
        console.error(error);
    }
}

function showPermutationPreview(result) {
    const previewSection = document.getElementById('previewSection');
    
    let html = `
        <div class="alert alert-info">
            <h6><i class="fas fa-magic me-2"></i>ตัวอย่าง Permutations ที่จะถูกสร้าง</h6>
            <div class="row text-center mb-2">
                <div class="col-4">
                    <strong class="text-primary">${result.total_input}</strong><br>
                    <small>ข้อมูลนำเข้า</small>
                </div>
                <div class="col-4">
                    <strong class="text-success">${result.total_output}</strong><br>
                    <small>รายการที่สร้าง</small>
                </div>
                <div class="col-4">
                    <strong class="text-warning">${result.stats.total_records}</strong><br>
                    <small>รวมทั้งหมด</small>
                </div>
            </div>
        </div>
        <div class="preview-list" style="max-height: 400px; overflow-y: auto;">
    `;
    
    // Group by original input
    const groupedRecords = {};
    result.records.forEach(record => {
        const key = record.original_input;
        if (!groupedRecords[key]) {
            groupedRecords[key] = {};
        }
        
        const field = record.field;
        if (!groupedRecords[key][field]) {
            groupedRecords[key][field] = [];
        }
        groupedRecords[key][field].push(record.number_norm);
    });
    
    // Show grouped results
    Object.keys(groupedRecords).forEach(originalInput => {
        const fieldGroups = groupedRecords[originalInput];
        
        html += `
            <div class="card mb-2">
                <div class="card-header py-2">
                    <strong>เลข ${originalInput}</strong> 
                    <span class="badge bg-secondary ms-1">${Object.values(fieldGroups).flat().length} รายการ</span>
                </div>
                <div class="card-body py-2">
        `;
        
        // Show each field group
        Object.keys(fieldGroups).forEach(field => {
            const numbers = fieldGroups[field];
            const fieldName = fieldOptions[field] || field;
            
            html += `
                <div class="mb-2">
                    <span class="badge bg-primary me-2">${fieldName}</span>
                    <small class="text-muted">(${numbers.length} รายการ)</small>
                    <div class="mt-1">
            `;
            
            numbers.forEach(number => {
                html += `<span class="badge bg-danger me-1 mb-1">${number}</span>`;
            });
            
            html += `
                    </div>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    previewSection.innerHTML = html;
}

function validateNumbers() {
    const numbers = getNumbersData();
    
    if (numbers.length === 0) {
        alert('กรุณากรอกข้อมูลเลขอั้นอย่างน้อย 1 รายการ');
        return false;
    }
    
    let errors = [];
    const seen = new Set();
    
    numbers.forEach((item, index) => {
        // Check duplicates
        const key = `${item.field}-${item.number}`;
        if (seen.has(key)) {
            errors.push(`แถวที่ ${index + 1}: เลข ${item.number} ในประเภท ${fieldOptions[item.field]} ซ้ำกัน`);
        }
        seen.add(key);
        
        // Check number format
        if (!/^\d{2,3}$/.test(item.number)) {
            errors.push(`แถวที่ ${index + 1}: เลข "${item.number}" ไม่ถูกต้อง (ต้องเป็นตัวเลข 2-3 หลัก)`);
        }
    });
    
    if (errors.length > 0) {
        alert('พบข้อผิดพลาด:\\n' + errors.slice(0, 5).join('\\n') + 
              (errors.length > 5 ? '\\n...' : ''));
        return false;
    }
    
    alert(`ตรวจสอบเรียบร้อย! พร้อมบันทึก ${numbers.length} รายการ`);
    return true;
}

function submitForm() {
    const numbers = getNumbersData();
    
    if (!validateNumbers()) {
        return false;
    }
    
    // Set numbers data
    document.getElementById('numbersData').value = JSON.stringify(numbers);
    
    return confirm(`ต้องการบันทึกเลขอั้น ${numbers.length} รายการหรือไม่?`);
}
</script>

<style>
.preview-item {
    transition: all 0.2s ease;
}

.preview-item:hover {
    background-color: #f8f9fa;
    border-color: #dee2e6 !important;
}

.table th {
    border-top: none;
}

.form-select-sm, .form-control-sm {
    font-size: 0.875rem;
}

#numbersTable tbody tr:hover {
    background-color: #f8f9fa;
}
</style>
{% endblock %}
