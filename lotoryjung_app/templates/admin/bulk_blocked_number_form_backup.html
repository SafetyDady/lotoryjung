{% extends "shared/base.html" %}

{% block title %}{{ title }} - Admin{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-ban me-2 text-danger"></i>{{ title }}
                    </h2>
                    <p class="text-muted mb-0">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</p>
                </div>
                <div>
                    <a href="{{ url_for('admin.blocked_numbers') }}" class="btn btn-secondary me-2">
                        <i class="fas fa-arrow-left me-1"></i>‡∏Å‡∏•‡∏±‡∏ö
                    </a>
                    <a href="{{ url_for('admin.add_blocked_number') }}" class="btn btn-outline-primary">
                        <i class="fas fa-plus me-1"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡∏•‡∏∞‡∏ï‡∏±‡∏ß
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Form Section -->
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-table me-2"></i>‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏≠‡∏±‡πâ‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏ï‡∏±‡∏ß
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Warning Message -->
                    <div class="alert alert-warning mb-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</strong> ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞<strong>‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</strong>‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ 
                        (‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏Ç‡∏≠‡∏±‡πâ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏á‡∏ß‡∏î)
                    </div>
                    
                    <!-- Quick Add Buttons -->
                    <div class="mb-3">
                        <label class="form-label">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏£‡πá‡∏ß:</label>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-success btn-sm" onclick="addStandardSet()">
                                <i class="fas fa-magic me-1"></i>‡∏ä‡∏∏‡∏î‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô (10+5)
                            </button>
                            <button type="button" class="btn btn-outline-info btn-sm" onclick="addSample()">
                                <i class="fas fa-flask me-1"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
                            </button>
                        </div>
                    </div>

                    <!-- Numbers Input Table -->
                    <div class="table-responsive">
                        <div class="row">
                            <!-- 2 ‡∏´‡∏•‡∏±‡∏Å Column -->
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-primary text-white text-center">
                                        <h6 class="mb-0">2 ‡∏´‡∏•‡∏±‡∏Å</h6>
                                    </div>
                                    <div class="card-body p-2">
                                        <div id="twoDigitInputs">
                                            <!-- 2-digit inputs will be added here -->
                                        </div>
                                        <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="addTwoDigitRow()">
                                            <i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 3 ‡∏´‡∏•‡∏±‡∏Å Column -->
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-success text-white text-center">
                                        <h6 class="mb-0">3 ‡∏´‡∏•‡∏±‡∏Å</h6>
                                    </div>
                                    <div class="card-body p-2">
                                        <div id="threeDigitInputs">
                                            <!-- 3-digit inputs will be added here -->
                                        </div>
                                        <button type="button" class="btn btn-outline-success btn-sm mt-2" onclick="addThreeDigitRow()">
                                            <i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addMultipleTwoDigit(10)">
                                +10 ‡∏ä‡πà‡∏≠‡∏á (2‡∏´‡∏•‡∏±‡∏Å)
                            </button>
                            <button type="button" class="btn btn-outline-success btn-sm" onclick="addMultipleThreeDigit(5)">
                                +5 ‡∏ä‡πà‡∏≠‡∏á (3‡∏´‡∏•‡∏±‡∏Å)
                            </button>
                            <button type="button" class="btn btn-outline-warning btn-sm" onclick="clearAll()">
                                <i class="fas fa-trash me-1"></i>‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                            </button>
                        </div>
                        <span class="text-muted">
                            ‡∏£‡∏ß‡∏°: <strong id="rowCount">0</strong> ‡∏ï‡∏±‡∏ß
                        </span>
                    </div>
                </div>
            </div>

            <!-- Common Settings -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-cog me-2"></i>‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
                    </h6>
                </div>
                <div class="card-body">
                    <form method="POST" id="bulkForm">
                        {{ form.hidden_tag() }}
                        
                        <div class="row">
                            <div class="col-md-8">
                                {{ form.reason.label(class="form-label") }}
                                {{ form.reason(class="form-control", rows="2", placeholder="‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏Ç‡∏≠‡∏±‡πâ‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)") }}
                            </div>
                            <div class="col-md-4">
                                <div class="form-check form-switch mt-4">
                                    {{ form.is_active(class="form-check-input", id="isActiveSwitch") }}
                                    {{ form.is_active.label(class="form-check-label", for="isActiveSwitch") }}
                                </div>
                            </div>
                        </div>
                        
                        <input type="hidden" id="numbersData" name="numbers_data" value="">
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                            <button type="button" class="btn btn-outline-info me-md-2" onclick="previewPermutations()">
                                <i class="fas fa-eye me-1"></i>‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Permutations
                            </button>
                            <button type="button" class="btn btn-outline-secondary me-md-2" onclick="validateNumbers()">
                                <i class="fas fa-check me-1"></i>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                            </button>
                            {{ form.submit(class="btn btn-danger", onclick="return submitForm()") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Preview Section -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-eye me-2"></i>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
                    </h6>
                </div>
                <div class="card-body">
                    <div id="previewSection">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-info-circle fa-2x mb-2"></i>
                            <p class="mb-0">‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</p>
                            <small class="text-muted">2‡∏´‡∏•‡∏±‡∏Å‚Üí4‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£, 3‡∏´‡∏•‡∏±‡∏Å‚Üí7‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border-end">
                                <h4 class="text-primary mb-0" id="stats2Digit">0</h4>
                                <small class="text-muted">2 ‡∏´‡∏•‡∏±‡∏Å (√ó4)</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <h4 class="text-success mb-0" id="stats3Digit">0</h4>
                            <small class="text-muted">3 ‡∏´‡∏•‡∏±‡∏Å (√ó7)</small>
                        </div>
                    </div>
                    <hr class="my-2">
                    <div class="text-center">
                        <h5 class="text-danger mb-0" id="statsTotal">0</h5>
                        <small class="text-muted">‡∏£‡∏ß‡∏°‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (records)</small>
                    </div>
                </div>
            </div>

            <!-- Help -->
            <div class="card mt-3">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="fas fa-lightbulb me-2 text-warning"></i>
                        ‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö
                    </h6>
                    <ul class="list-unstyled small mb-0">
                        <li class="mb-2">
                            <i class="fas fa-magic text-warning me-1"></i>
                            <strong>2 ‡∏´‡∏•‡∏±‡∏Å</strong> ‡∏™‡∏£‡πâ‡∏≤‡∏á 4 permutations ‡πÉ‡∏ô field ‡πÄ‡∏î‡∏¥‡∏°
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-magic text-warning me-1"></i>
                            <strong>3 ‡∏´‡∏•‡∏±‡∏Å</strong> ‡∏™‡∏£‡πâ‡∏≤‡∏á 6 permutations + 1 tote = 7 records
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-info-circle text-info me-1"></i>
                            ‡πÄ‡∏ä‡πà‡∏ô: 157 ‚Üí 6 ‡πÉ‡∏ô 3_top + 1 ‡πÉ‡∏ô tote
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-1"></i>
                            ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏ï‡∏¥‡∏° 0 ‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                        </li>
                        <li class="mb-0">
                            <i class="fas fa-check text-success me-1"></i>
                            ‡∏Å‡∏î‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Permutations ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let twoDigitCounter = 0;
let threeDigitCounter = 0;

document.addEventListener('DOMContentLoaded', function() {
    // Add initial standard set
    addStandardSet();
    updatePreview();
});

function addStandardSet() {
    clearAll();
    addMultipleTwoDigit(10);
    addMultipleThreeDigit(5);
}

function addSample() {
    clearAll();
    // Add sample 2-digit numbers
    addTwoDigitRow('11');
    addTwoDigitRow('22');
    addTwoDigitRow('33');
    
    // Add sample 3-digit numbers
    addThreeDigitRow('123');
    addThreeDigitRow('456');
}

function addTwoDigitRow(value = '') {
    twoDigitCounter++;
    const container = document.getElementById('twoDigitInputs');
    const div = document.createElement('div');
    div.className = 'input-group input-group-sm mb-1';
    div.id = `twoDigit_${twoDigitCounter}`;
    
    div.innerHTML = `
        <span class="input-group-text" style="width: 35px;">${twoDigitCounter}</span>
        <input type="text" class="form-control" name="two_digit_${twoDigitCounter}" 
               value="${value}" placeholder="‡πÄ‡∏ä‡πà‡∏ô 12, 99" maxlength="2" 
               oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 2); updatePreview()"
               onchange="updatePreview()">
        <button type="button" class="btn btn-outline-danger" onclick="removeTwoDigitRow(${twoDigitCounter})">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    container.appendChild(div);
    updateRowCount();
}

function addThreeDigitRow(value = '') {
    threeDigitCounter++;
    const container = document.getElementById('threeDigitInputs');
    const div = document.createElement('div');
    div.className = 'input-group input-group-sm mb-1';
    div.id = `threeDigit_${threeDigitCounter}`;
    
    div.innerHTML = `
        <span class="input-group-text" style="width: 35px;">${threeDigitCounter}</span>
        <input type="text" class="form-control" name="three_digit_${threeDigitCounter}" 
               value="${value}" placeholder="‡πÄ‡∏ä‡πà‡∏ô 123, 789" maxlength="3" 
               oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 3); updatePreview()"
               onchange="updatePreview()">
        <button type="button" class="btn btn-outline-danger" onclick="removeThreeDigitRow(${threeDigitCounter})">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    container.appendChild(div);
    updateRowCount();
}

function addMultipleTwoDigit(count) {
    for (let i = 0; i < count; i++) {
        addTwoDigitRow();
    }
}

function addMultipleThreeDigit(count) {
    for (let i = 0; i < count; i++) {
        addThreeDigitRow();
    }
}

function removeTwoDigitRow(id) {
    const element = document.getElementById(`twoDigit_${id}`);
    if (element) {
        element.remove();
        updateRowCount();
        updatePreview();
    }
}

function removeThreeDigitRow(id) {
    const element = document.getElementById(`threeDigit_${id}`);
    if (element) {
        element.remove();
        updateRowCount();
        updatePreview();
    }
}

function clearAll() {
    document.getElementById('twoDigitInputs').innerHTML = '';
    document.getElementById('threeDigitInputs').innerHTML = '';
    twoDigitCounter = 0;
    threeDigitCounter = 0;
    updateRowCount();
    updatePreview();
}

function updateRowCount() {
    const twoDigitCount = document.querySelectorAll('#twoDigitInputs .input-group').length;
    const threeDigitCount = document.querySelectorAll('#threeDigitInputs .input-group').length;
    const total = twoDigitCount + threeDigitCount;
    
    document.getElementById('rowCount').textContent = total;
}

function updatePreview() {
    const twoDigitInputs = document.querySelectorAll('#twoDigitInputs input[type="text"]');
    const threeDigitInputs = document.querySelectorAll('#threeDigitInputs input[type="text"]');
    
    let twoDigitCount = 0;
    let threeDigitCount = 0;
    
    // Count valid 2-digit numbers
    twoDigitInputs.forEach(input => {
        if (input.value.trim() && input.value.length >= 1) {
            twoDigitCount++;
        }
    });
    
    // Count valid 3-digit numbers
    threeDigitInputs.forEach(input => {
        if (input.value.trim() && input.value.length >= 1) {
            threeDigitCount++;
        }
    });
    
    // Update statistics
    document.getElementById('stats2Digit').textContent = twoDigitCount;
    document.getElementById('stats3Digit').textContent = threeDigitCount;
    
    const totalRecords = (twoDigitCount * 4) + (threeDigitCount * 7);
    document.getElementById('statsTotal').textContent = totalRecords;
}

function validateNumbers() {
    const twoDigitInputs = document.querySelectorAll('#twoDigitInputs input[type="text"]');
    const threeDigitInputs = document.querySelectorAll('#threeDigitInputs input[type="text"]');
    
    let errors = [];
    let validCount = 0;
    
    // Validate 2-digit numbers
    twoDigitInputs.forEach((input, index) => {
        const value = input.value.trim();
        if (value) {
            if (!/^\d{1,2}$/.test(value)) {
                errors.push(`2‡∏´‡∏•‡∏±‡∏Å ‡πÅ‡∏ñ‡∏ß ${index + 1}: ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`);
                input.classList.add('is-invalid');
            } else {
                input.classList.remove('is-invalid');
                validCount++;
            }
        }
    });
    
    // Validate 3-digit numbers
    threeDigitInputs.forEach((input, index) => {
        const value = input.value.trim();
        if (value) {
            if (!/^\d{1,3}$/.test(value)) {
                errors.push(`3‡∏´‡∏•‡∏±‡∏Å ‡πÅ‡∏ñ‡∏ß ${index + 1}: ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`);
                input.classList.add('is-invalid');
            } else {
                input.classList.remove('is-invalid');
                validCount++;
            }
        }
    });
    
    if (errors.length > 0) {
        alert('‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:\\n' + errors.join('\\n'));
        return false;
    }
    
    if (validCount === 0) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ï‡∏±‡∏ß');
        return false;
    }
    
    alert(`‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ${validCount} ‡∏ï‡∏±‡∏ß`);
    return true;
}

function previewPermutations() {
    const twoDigitInputs = document.querySelectorAll('#twoDigitInputs input[type="text"]');
    const threeDigitInputs = document.querySelectorAll('#threeDigitInputs input[type="text"]');
    
    let preview = 'üîç ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Permutations:\\n\\n';
    let hasData = false;
    
    // Preview 2-digit permutations
    twoDigitInputs.forEach((input, index) => {
        const value = input.value.trim();
        if (value && value.length >= 1) {
            hasData = true;
            const padded = value.padStart(2, '0');
            const reversed = padded.split('').reverse().join('');
            
            preview += `üìã 2‡∏´‡∏•‡∏±‡∏Å: "${value}" ‚Üí "${padded}"\\n`;
            preview += `   ‚Ä¢ 2_top: ${padded}, ${reversed}\\n`;
            preview += `   ‚Ä¢ 2_bottom: ${padded}, ${reversed}\\n`;
            preview += `   ‡∏£‡∏ß‡∏°: 4 records\\n\\n`;
        }
    });
    
    // Preview 3-digit permutations
    threeDigitInputs.forEach((input, index) => {
        const value = input.value.trim();
        if (value && value.length >= 1) {
            hasData = true;
            const padded = value.padStart(3, '0');
            
            preview += `üìã 3‡∏´‡∏•‡∏±‡∏Å: "${value}" ‚Üí "${padded}"\\n`;
            preview += `   ‚Ä¢ 3_top: 6 permutations\\n`;
            preview += `   ‚Ä¢ tote: 1 tote number\\n`;
            preview += `   ‡∏£‡∏ß‡∏°: 7 records\\n\\n`;
        }
    });
    
    if (!hasData) {
        preview = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏Å‡πà‡∏≠‡∏ô';
    }
    
    alert(preview);
}

function submitForm() {
    if (!validateNumbers()) {
        return false;
    }
    
    const twoDigitInputs = document.querySelectorAll('#twoDigitInputs input[type="text"]');
    const threeDigitInputs = document.querySelectorAll('#threeDigitInputs input[type="text"]');
    
    let numbersData = [];
    
    // Collect 2-digit numbers
    twoDigitInputs.forEach(input => {
        const value = input.value.trim();
        if (value) {
            numbersData.push({
                number: value,
                type: '2_digit'
            });
        }
    });
    
    // Collect 3-digit numbers
    threeDigitInputs.forEach(input => {
        const value = input.value.trim();
        if (value) {
            numbersData.push({
                number: value,
                type: '3_digit'
            });
        }
    });
    
        // Set the JSON data to hidden field
    document.getElementById('numbersData').value = JSON.stringify(numbersData);
    
    return true;
}

function updateStats(count2, count3) {
    document.getElementById('stats2Digit').textContent = count2;
    document.getElementById('stats3Digit').textContent = count3;
    
    // Calculate total records (2-digit √ó 4, 3-digit √ó 7)  
    const totalRecords = (count2 * 4) + (count3 * 7);
    document.getElementById('statsTotal').textContent = totalRecords;
}

async function previewPermutations() {
    const numbers = getNumbersData();
    
    if (numbers.length === 0) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
        return;
    }
    
    try {
        const response = await fetch('{{ url_for("admin.bulk_add_blocked_numbers") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(numbers)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showPermutationPreview(result);
        } else {
            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + 
                  (result.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ'));
        }
    } catch (error) {
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message);
        console.error(error);
    }
}

function showPermutationPreview(result) {
    const previewSection = document.getElementById('previewSection');
    let html = '';
    
    // Group by original input
    const groupedRecords = {};
    result.records.forEach(record => {
        const key = record.original_input;
        if (!groupedRecords[key]) {
            groupedRecords[key] = {};
        }
        const field = record.field;
        if (!groupedRecords[key][field]) {
            groupedRecords[key][field] = [];
        }
        groupedRecords[key][field].push(record.number_norm);
    });
    
    // Show grouped results
    Object.keys(groupedRecords).forEach(originalInput => {
        const fieldGroups = groupedRecords[originalInput];
        html += `<h6 class="mb-2"><span class="badge bg-primary">${originalInput}</span> (${originalInput.length} ‡∏´‡∏•‡∏±‡∏Å) ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:</h6>`;
        
        // Show each field group
        Object.keys(fieldGroups).forEach(field => {
            const numbers = fieldGroups[field];
            const fieldName = fieldOptions[field] || field;
            html += `<p class="mb-1"><strong>${fieldName}:</strong> `;
            numbers.forEach(number => {
                html += `<span class="badge bg-secondary me-1">${number}</span>`;
            });
            html += ` (${numbers.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</p>`;
        });
        html += '<hr class="my-2">';
    });
    
    previewSection.innerHTML = html;
}

function validateNumbers() {
    const numbers = getNumbersData();
    
    if (numbers.length === 0) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
        return false;
    }
    
    let errors = [];
    const seen = new Set();
    
    numbers.forEach((item, index) => {
        // Check duplicates
        const key = `${item.field}:${item.number}`;
        if (seen.has(key)) {
            errors.push(`‡πÅ‡∏ñ‡∏ß ${index + 1}: ‡πÄ‡∏•‡∏Ç "${item.number}" ‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô`);
        } else {
            seen.add(key);
        }
        
        // Check number format
        if (!/^\d{2,3}$/.test(item.number)) {
            errors.push(`‡πÅ‡∏ñ‡∏ß ${index + 1}: ‡πÄ‡∏•‡∏Ç‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 2-3 ‡∏´‡∏•‡∏±‡∏Å`);
        }
    });
    
    if (errors.length > 0) {
        alert('‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:
' + errors.slice(0, 5).join('
') + 
              (errors.length > 5 ? '
...' : ''));
        return false;
    }
    
    alert(`‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ${numbers.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
    return true;
}

function submitForm() {
    const numbers = getNumbersData();
    
    if (!validateNumbers()) {
        return false;
    }
    
    // Set numbers data
    document.getElementById('numbersData').value = JSON.stringify(numbers);
    
    return confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏Ç‡∏≠‡∏±‡πâ‡∏ô ${numbers.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`);
}
</script>
</script>

</script>

</body>
</html>

function updateStats(count2, count3) {
    document.getElementById('stats2Digit').textContent = count2;
    document.getElementById('stats3Digit').textContent = count3;
    
    // Calculate total records (2-digit √ó 4, 3-digit √ó 7)  
    const totalRecords = (count2 * 4) + (count3 * 7);
    document.getElementById('statsTotal').textContent = totalRecords;
}

function updateStats(count2, count3) {
    document.getElementById('stats2Digit').textContent = count2;
    document.getElementById('stats3Digit').textContent = count3;
    
    // Calculate total records (2-digit √ó 4, 3-digit √ó 7)
    const totalRecords = (count2 * 4) + (count3 * 7);
    document.getElementById('statsTotal').textContent = totalRecords;
}

async function previewPermutations() {
    const numbers = getNumbersData();
    
    if (numbers.length === 0) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡∏Ç‡∏≠‡∏±‡πâ‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
        return;
    }
    
    try {
        const response = await fetch('/admin/blocked_numbers/preview', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ numbers: numbers })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showPermutationPreview(result);
        } else {
            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (result.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ'));
        }
        
    } catch (error) {
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á');
        console.error(error);
    }
}

function showPermutationPreview(result) {
    const previewSection = document.getElementById('previewSection');
    
    let html = `
        <div class="alert alert-info">
            <h6><i class="fas fa-magic me-2"></i>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Permutations ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á</h6>
            <div class="row text-center mb-2">
                <div class="col-4">
                    <strong class="text-primary">${result.total_input}</strong><br>
                    <small>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</small>
                </div>
                <div class="col-4">
                    <strong class="text-success">${result.total_output}</strong><br>
                    <small>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á</small>
                </div>
                <div class="col-4">
                    <strong class="text-warning">${result.stats.total_records}</strong><br>
                    <small>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small>
                </div>
            </div>
        </div>
        <div class="preview-list" style="max-height: 400px; overflow-y: auto;">
    `;
    
    // Group by original input
    const groupedRecords = {};
    result.records.forEach(record => {
        const key = record.original_input;
        if (!groupedRecords[key]) {
            groupedRecords[key] = {};
        }
        
        const field = record.field;
        if (!groupedRecords[key][field]) {
            groupedRecords[key][field] = [];
        }
        groupedRecords[key][field].push(record.number_norm);
    });
    
    // Show grouped results
    Object.keys(groupedRecords).forEach(originalInput => {
        const fieldGroups = groupedRecords[originalInput];
        
        html += `
            <div class="card mb-2">
                <div class="card-header py-2">
                    <strong>‡πÄ‡∏•‡∏Ç ${originalInput}</strong> 
                    <span class="badge bg-secondary ms-1">${Object.values(fieldGroups).flat().length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                </div>
                <div class="card-body py-2">
        `;
        
        // Show each field group
        Object.keys(fieldGroups).forEach(field => {
            const numbers = fieldGroups[field];
            const fieldName = fieldOptions[field] || field;
            
            html += `
                <div class="mb-2">
                    <span class="badge bg-primary me-2">${fieldName}</span>
                    <small class="text-muted">(${numbers.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</small>
                    <div class="mt-1">
            `;
            
            numbers.forEach(number => {
                html += `<span class="badge bg-danger me-1 mb-1">${number}</span>`;
            });
            
            html += `
                    </div>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    previewSection.innerHTML = html;
}

function validateNumbers() {
    const numbers = getNumbersData();
    
    if (numbers.length === 0) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡∏Ç‡∏≠‡∏±‡πâ‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
        return false;
    }
    
    let errors = [];
    const seen = new Set();
    
    numbers.forEach((item, index) => {
        // Check duplicates
        const key = `${item.field}-${item.number}`;
        if (seen.has(key)) {
            errors.push(`‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${index + 1}: ‡πÄ‡∏•‡∏Ç ${item.number} ‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó ${fieldOptions[item.field]} ‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô`);
        }
        seen.add(key);
        
        // Check number format
        if (!/^\d{2,3}$/.test(item.number)) {
            errors.push(`‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${index + 1}: ‡πÄ‡∏•‡∏Ç "${item.number}" ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 2-3 ‡∏´‡∏•‡∏±‡∏Å)`);
        }
    });
    
    if (errors.length > 0) {
        alert('‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:\\n' + errors.slice(0, 5).join('\\n') + 
              (errors.length > 5 ? '\\n...' : ''));
        return false;
    }
    
    alert(`‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ${numbers.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
    return true;
}

function submitForm() {
    const numbers = getNumbersData();
    
    if (!validateNumbers()) {
        return false;
    }
    
    // Set numbers data
    document.getElementById('numbersData').value = JSON.stringify(numbers);
    
    return confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏Ç‡∏≠‡∏±‡πâ‡∏ô ${numbers.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`);
}
</script>

<style>
.preview-item {
    transition: all 0.2s ease;
}

.preview-item:hover {
    background-color: #f8f9fa;
    border-color: #dee2e6 !important;
}

.table th {
    border-top: none;
}

.form-select-sm, .form-control-sm {
    font-size: 0.875rem;
}

#numbersTable tbody tr:hover {
    background-color: #f8f9fa;
}
</style>
{% endblock %}
